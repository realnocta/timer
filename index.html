<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Time Blocks Progress</title>
  <style>
    :root{
      --bg: #0b0c10;
      --card: rgba(255,255,255,0.06);
      --card2: rgba(255,255,255,0.085);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.68);
      --muted2: rgba(255,255,255,0.52);
      --stroke: rgba(255,255,255,0.14);
      --accent: #ffffff;
      --shadow: 0 20px 60px rgba(0,0,0,0.55);
      --radius: 18px;
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--text);
      background:
        radial-gradient(900px 500px at 20% 0%, rgba(255,255,255,0.12), transparent 55%),
        radial-gradient(700px 450px at 90% 30%, rgba(255,255,255,0.10), transparent 55%),
        radial-gradient(800px 500px at 50% 110%, rgba(255,255,255,0.08), transparent 55%),
        var(--bg);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 28px 16px;
    }

    .wrap{
      width: min(980px, 100%);
      display:grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 18px;
    }

    @media (max-width: 920px){
      .wrap{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, var(--card), rgba(255,255,255,0.03));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .card .hd{
      padding: 18px 18px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }

    .title{
      font-size: 14px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
      margin: 0;
    }

    .sub{
      margin: 8px 0 0;
      color: var(--muted2);
      font-size: 13px;
      line-height: 1.4;
    }

    .btns{
      display:flex; gap:10px; flex-wrap:wrap;
      justify-content:flex-end;
    }

    button{
      appearance:none;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 13px;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      white-space:nowrap;
    }
    button:hover{ background: rgba(255,255,255,0.09); border-color: rgba(255,255,255,0.2); }
    button:active{ transform: translateY(1px); }
    button.primary{
      background: rgba(255,255,255,0.92);
      color: #0b0c10;
      border-color: rgba(255,255,255,0.35);
    }
    button.primary:hover{ background: rgba(255,255,255,0.98); }

    .content{
      padding: 0 18px 18px;
    }

    /* Progress area */
    .center{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      min-height: 330px;
    }

    .progressBox{
      width: min(520px, 100%);
      padding: 18px;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      border: 1px solid rgba(255,255,255,0.14);
    }

    .bigPercent{
      font-size: 52px;
      font-weight: 800;
      letter-spacing: -0.03em;
      margin: 2px 0 10px;
      line-height: 1;
    }

    .metaRow{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 10px;
      margin: 10px 0 12px;
      color: var(--muted);
      font-size: 13px;
    }

    .bar{
      height: 14px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.12);
      overflow:hidden;
    }
    .fill{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: rgba(255,255,255,0.92);
      transform: translateZ(0);
      transition: width .35s ease;
    }

    .stats{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .stat{
      padding: 12px;
      border-radius: 14px;
      background: rgba(255,255,255,0.055);
      border: 1px solid rgba(255,255,255,0.12);
    }
    .k{
      font-size: 12px;
      color: var(--muted2);
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
    .v{
      margin-top: 6px;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    /* Intervals form */
    .list{
      display:flex;
      flex-direction:column;
      gap: 10px;
      margin-top: 12px;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 10px;
      align-items:center;
      padding: 12px;
      border-radius: 14px;
      background: rgba(255,255,255,0.045);
      border: 1px solid rgba(255,255,255,0.12);
    }

    label{
      display:flex;
      flex-direction:column;
      gap: 6px;
      font-size: 12px;
      color: var(--muted2);
      letter-spacing: 0.03em;
    }

    input[type="time"]{
      width: 100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.25);
      color: var(--text);
      outline:none;
      font-weight: 700;
      font-size: 13px;
    }
    input[type="time"]:focus{
      border-color: rgba(255,255,255,0.25);
      box-shadow: 0 0 0 4px rgba(255,255,255,0.06);
    }

    .tiny{
      font-size: 12px;
      color: var(--muted2);
      line-height: 1.45;
      margin-top: 10px;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
    }

    .okDot{
      width:8px; height:8px; border-radius:999px;
      background: rgba(255,255,255,0.85);
      box-shadow: 0 0 0 4px rgba(255,255,255,0.08);
    }

    .warnDot{
      width:8px; height:8px; border-radius:999px;
      background: rgba(255, 194, 92, 0.95);
      box-shadow: 0 0 0 4px rgba(255, 194, 92, 0.12);
    }

    .footerLine{
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.12);
      color: var(--muted2);
      font-size: 12px;
      display:flex;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
    }

    a{ color: rgba(255,255,255,0.85); }
    a:hover{ color: rgba(255,255,255,0.98); }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- LEFT: Progress -->
    <section class="card">
      <div class="hd">
        <div>
          <p class="title">Progressione</p>
          <p class="sub">Conta solo il tempo dentro gli intervalli. Le pause non incidono sul ‚Äútime remaining‚Äù.</p>
        </div>
        <div class="btns">
          <button id="btnNow" title="Sincronizza e aggiorna subito">Aggiorna</button>
          <button class="primary" id="btnStartStop" title="Avvia/Ferma l'aggiornamento">In pausa</button>
        </div>
      </div>

      <div class="center">
        <div class="progressBox">
          <div class="bigPercent" id="percentText">0%</div>

          <div class="metaRow">
            <div id="remainingText">Time remaining: --:--:--</div>
            <div id="clockText">--:--:--</div>
          </div>

          <div class="bar" aria-label="progress bar">
            <div class="fill" id="fill"></div>
          </div>

          <div class="stats">
            <div class="stat">
              <div class="k">Tempo totale</div>
              <div class="v" id="totalText">--:--:--</div>
            </div>
            <div class="stat">
              <div class="k">Fatto</div>
              <div class="v" id="doneText">--:--:--</div>
            </div>
            <div class="stat">
              <div class="k">Rimanente</div>
              <div class="v" id="leftText">--:--:--</div>
            </div>
            <div class="stat">
              <div class="k">Stato</div>
              <div class="v" id="stateText">‚Äî</div>
            </div>
          </div>

          <div class="chip" id="chip">
            <span class="warnDot" id="dot"></span>
            <span id="chipText">Inserisci almeno un intervallo.</span>
          </div>

          <div class="footerLine">
            <span id="intervalSummary">Intervalli attivi: ‚Äî</span>
            <span>Salvato in locale ‚Ä¢ <a href="#" id="btnReset">reset</a></span>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT: Intervals -->
    <section class="card">
      <div class="hd">
        <div>
          <p class="title">Intervalli</p>
          <p class="sub">Aggiungi orari (es. 08:00‚Äì12:15, 13:15‚Äì17:00). Puoi aggiungerne quanti vuoi.</p>
        </div>
        <div class="btns">
          <button id="btnAdd">+ Aggiungi</button>
          <button id="btnSave" class="primary">Salva</button>
        </div>
      </div>

      <div class="content">
        <div class="list" id="list"></div>
        <div class="tiny">
          Note: se due intervalli si sovrappongono (o si toccano), vengono uniti automaticamente per calcolare il totale.
        </div>
      </div>
    </section>

  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const listEl = $("list");
  const btnAdd = $("btnAdd");
  const btnSave = $("btnSave");
  const btnReset = $("btnReset");
  const btnNow = $("btnNow");
  const btnStartStop = $("btnStartStop");

  const percentText = $("percentText");
  const remainingText = $("remainingText");
  const clockText = $("clockText");
  const fill = $("fill");
  const totalText = $("totalText");
  const doneText = $("doneText");
  const leftText = $("leftText");
  const stateText = $("stateText");
  const chipText = $("chipText");
  const dot = $("dot");
  const intervalSummary = $("intervalSummary");

  const STORAGE_KEY = "timeBlocksIntervalsV1";

  let timer = null;
  let running = false;

  function pad(n){ return String(n).padStart(2,"0"); }

  function fmtHMS(ms){
    ms = Math.max(0, Math.floor(ms));
    const s = Math.floor(ms / 1000);
    const hh = Math.floor(s / 3600);
    const mm = Math.floor((s % 3600) / 60);
    const ss = s % 60;
    return `${pad(hh)}:${pad(mm)}:${pad(ss)}`;
  }

  function parseTimeToMinutes(t){
    // t = "HH:MM"
    if(!t || !/^\d{2}:\d{2}$/.test(t)) return null;
    const [h,m] = t.split(":").map(Number);
    if(h < 0 || h > 23 || m < 0 || m > 59) return null;
    return h*60 + m;
  }

  function minutesToLabel(min){
    const h = Math.floor(min/60), m = min%60;
    return `${pad(h)}:${pad(m)}`;
  }

  function todayStart(){
    const d = new Date();
    d.setHours(0,0,0,0);
    return d;
  }

  function minsToDate(mins){
    const d = todayStart();
    d.setMinutes(mins, 0, 0);
    return d;
  }

  function getRows(){
    return Array.from(listEl.querySelectorAll(".row"));
  }

  function addRow(start="08:00", end="12:15"){
    const row = document.createElement("div");
    row.className = "row";

    row.innerHTML = `
      <label>
        Inizio
        <input type="time" step="60" value="${start}">
      </label>
      <label>
        Fine
        <input type="time" step="60" value="${end}">
      </label>
      <button title="Rimuovi" aria-label="Rimuovi intervallo">‚úï</button>
    `;

    const removeBtn = row.querySelector("button");
    removeBtn.addEventListener("click", () => {
      row.remove();
      updateUI();
    });

    const inputs = row.querySelectorAll('input[type="time"]');
    inputs.forEach(i => i.addEventListener("change", updateUI));

    listEl.appendChild(row);
    updateUI();
  }

  function readIntervalsFromUI(){
    const rows = getRows();
    const raw = rows.map(r => {
      const inputs = r.querySelectorAll('input[type="time"]');
      return { start: inputs[0].value, end: inputs[1].value };
    });

    const parsed = [];
    const errors = [];

    raw.forEach((it, idx) => {
      const s = parseTimeToMinutes(it.start);
      const e = parseTimeToMinutes(it.end);
      if(s === null || e === null){
        errors.push(`Intervallo #${idx+1}: orario non valido.`);
        return;
      }
      if(e <= s){
        errors.push(`Intervallo #${idx+1}: la fine deve essere dopo l'inizio.`);
        return;
      }
      parsed.push([s,e]);
    });

    return { parsed, errors };
  }

  function mergeIntervals(intervals){
    // intervals: array of [startMin, endMin], non-empty, valid
    const sorted = [...intervals].sort((a,b) => a[0]-b[0]);
    const merged = [];
    for(const [s,e] of sorted){
      if(!merged.length) merged.push([s,e]);
      else{
        const last = merged[merged.length-1];
        if(s <= last[1]) last[1] = Math.max(last[1], e); // overlap or touch
        else merged.push([s,e]);
      }
    }
    return merged;
  }

  function calc(now = new Date()){
    const { parsed, errors } = readIntervalsFromUI();
    if(errors.length) return { ok:false, errors };

    const merged = mergeIntervals(parsed);

    const totalMs = merged.reduce((acc,[s,e]) => acc + (e-s)*60*1000, 0);

    // elapsed within intervals only
    const nowMs = now.getTime();
    let doneMs = 0;

    for(const [s,e] of merged){
      const ds = minsToDate(s).getTime();
      const de = minsToDate(e).getTime();

      if(nowMs <= ds){
        // nothing done in this interval
        continue;
      } else if(nowMs >= de){
        doneMs += (de - ds);
      } else {
        doneMs += (nowMs - ds);
      }
    }

    doneMs = Math.min(doneMs, totalMs);
    const leftMs = Math.max(0, totalMs - doneMs);
    const pct = totalMs > 0 ? (doneMs / totalMs) : 0;

    // state label
    let state = "Fuori intervallo";
    let next = null;

    for(const [s,e] of merged){
      const ds = minsToDate(s).getTime();
      const de = minsToDate(e).getTime();
      if(nowMs >= ds && nowMs < de){
        state = "In corso";
        next = { type:"ends", at: e };
        break;
      }
      if(nowMs < ds){
        next = { type:"starts", at: s };
        break;
      }
    }
    if(totalMs > 0 && doneMs >= totalMs) state = "Completato";

    return { ok:true, merged, totalMs, doneMs, leftMs, pct, state, next };
  }

  function updateUI(){
    const now = new Date();
    clockText.textContent = now.toLocaleTimeString([], { hour:"2-digit", minute:"2-digit", second:"2-digit" });

    const result = calc(now);

    if(!result.ok){
      // show error status, but keep last numbers neutral
      dot.className = "warnDot";
      chipText.textContent = result.errors[0] || "Controlla gli intervalli.";
      intervalSummary.textContent = `Intervalli attivi: ${getRows().length}`;

      percentText.textContent = "‚Äî";
      remainingText.textContent = "Time remaining: ‚Äî";
      fill.style.width = "0%";
      totalText.textContent = "‚Äî";
      doneText.textContent = "‚Äî";
      leftText.textContent = "‚Äî";
      stateText.textContent = "‚Äî";
      return;
    }

    const { merged, totalMs, doneMs, leftMs, pct, state, next } = result;

    const pct100 = Math.round(pct * 1000) / 10; // 1 decimal
    const pctLabel = Number.isFinite(pct100) ? `${pct100}%` : "0%";

    percentText.textContent = totalMs > 0 ? pctLabel : "0%";
    fill.style.width = totalMs > 0 ? `${Math.min(100, pct*100)}%` : "0%";

    remainingText.textContent = `Time remaining: ${fmtHMS(leftMs)}`;
    totalText.textContent = fmtHMS(totalMs);
    doneText.textContent = fmtHMS(doneMs);
    leftText.textContent = fmtHMS(leftMs);
    stateText.textContent = state;

    // chip
    if(totalMs <= 0){
      dot.className = "warnDot";
      chipText.textContent = "Inserisci almeno un intervallo valido.";
    } else if(state === "In corso"){
      dot.className = "okDot";
      chipText.textContent = next ? `In corso ‚Ä¢ termina alle ${minutesToLabel(next.at)}` : "In corso";
    } else if(state === "Fuori intervallo"){
      dot.className = "warnDot";
      chipText.textContent = next ? `In pausa ‚Ä¢ prossimo inizio alle ${minutesToLabel(next.at)}` : "Fuori intervalli ‚Ä¢ nessun prossimo blocco";
    } else {
      dot.className = "okDot";
      chipText.textContent = "Completato üéâ";
    }

    const summary = merged.map(([s,e]) => `${minutesToLabel(s)}‚Äì${minutesToLabel(e)}`).join(" ¬∑ ");
    intervalSummary.textContent = `Intervalli attivi: ${merged.length}${summary ? " ‚Ä¢ " + summary : ""}`;
  }

  function save(){
    const rows = getRows().map(r => {
      const inputs = r.querySelectorAll('input[type="time"]');
      return { start: inputs[0].value, end: inputs[1].value };
    });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));
  }

  function load(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return false;
    try{
      const rows = JSON.parse(raw);
      if(!Array.isArray(rows)) return false;
      listEl.innerHTML = "";
      rows.forEach(r => addRow(r.start || "08:00", r.end || "12:15"));
      return true;
    }catch{
      return false;
    }
  }

  function start(){
    if(timer) clearInterval(timer);
    timer = setInterval(updateUI, 1000);
    running = true;
    btnStartStop.textContent = "In esecuzione";
    btnStartStop.classList.add("primary");
  }

  function stop(){
    if(timer) clearInterval(timer);
    timer = null;
    running = false;
    btnStartStop.textContent = "In pausa";
    btnStartStop.classList.remove("primary");
  }

  // events
  btnAdd.addEventListener("click", () => addRow("13:15","17:00"));
  btnSave.addEventListener("click", () => { save(); updateUI(); });
  btnNow.addEventListener("click", updateUI);

  btnReset.addEventListener("click", (e) => {
    e.preventDefault();
    localStorage.removeItem(STORAGE_KEY);
    listEl.innerHTML = "";
    addRow("08:00","12:15");
    addRow("13:15","17:00");
    save();
    updateUI();
  });

  btnStartStop.addEventListener("click", () => {
    if(running) stop();
    else start();
  });

  // init
  const loaded = load();
  if(!loaded){
    addRow("08:00","12:15");
    addRow("13:15","17:00");
    save();
  }
  updateUI();
  start();
})();
</script>
</body>
</html>
